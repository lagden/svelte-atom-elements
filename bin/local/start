#!/bin/bash

DIR="$(cd $(dirname $0) && pwd)"
BIN_DIR="$(cd $DIR/.. && pwd)"

# Import functions
. $BIN_DIR/helper/fn

# Usage
usage() {
	cat <<-EOF

  Usage: $0 [-wb]

  Options:
    -w     Watch and reload application
    -b     Just build the application
    -h     Show usage

EOF
exit 2
}

# Go to current directory
CURR_FOLDER="$(pwd)"
cd $CURR_FOLDER

OPT="development"

unset WATCH
WATCH=false

unset BUILD
BUILD=false

while getopts "wbh" o
do
	case ${o} in
		w) WATCH=true ;;
		b) BUILD=true ;;
		h) usage ;;
		\?) usage ;;
	esac
done

# ENV File
load_env $OPT

# Just build
if $BUILD; then
	ok "Building cmd: ${BUILD_LOCAL_CMD}"
	gen_env "${CURR_FOLDER}/resource/env.js"
	$BUILD_LOCAL_CMD
	if test $? -ne 0; then
		abort "Build failed"
	fi
	exit 0
fi

# Generate ENVs for frontend application
if test "${REQUIRE_GEN:-0}" = "1"; then
	gen_env "${CURR_FOLDER}/resource/env.js"
fi

if $WATCH; then
	ok "Running cmd: ${WATCH_LOCAL_CMD}"

	# Watch command
	eval ${WATCH_LOCAL_CMD}

	if test $? -ne 0; then
		abort "Watch failed"
	fi
else
	eval ${START_CMD}
fi

exit 0
